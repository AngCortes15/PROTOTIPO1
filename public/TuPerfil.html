<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tu Perfil - Tantuyo Centro Cultural</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }

    .main-container {
      min-height: 100vh;
      background: linear-gradient(135deg, #e9d5ff 0%, #6b21a8 100%);
      padding-bottom: 2rem;
    }

    .navbar {
      background: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
      padding: 0.8rem 2rem;
    }

    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      transition: transform 0.2s;
    }

    .navbar-brand:hover {
      transform: scale(1.02);
    }

    .brand-logo {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
    }

    .brand-name {
      font-weight: 700;
      font-size: 1.3rem;
      color: #4a2d8b;
      margin: 0;
    }

    .brand-tagline {
      font-size: 0.8rem;
      color: #6b7280;
      margin: 0;
    }

    /* Estilos para el saldo */
    .balance-display {
      background-color: #4a2d8b;
      border-radius: 50px;
      color: white;
      font-weight: 600;
      padding: 6px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
      margin-right: 20px;
      transition: all 0.2s;
      cursor: pointer;
    }

    .balance-display:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .balance-display i {
      color: gold;
    }

    .balance-value {
      letter-spacing: 0.5px;
    }

    /* Menú desplegable para el saldo */
    .balance-dropdown {
      position: relative;
    }

    .balance-menu {
      width: 180px;
      padding: 0;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      border: none;
      overflow: hidden;
      margin-top: 10px;
    }

    .balance-item {
      padding: 0.8rem 1.2rem;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .balance-item:hover {
      background-color: #f0f4f8;
    }

    .balance-item i {
      color: #4a2d8b;
    }

    .navbar-items {
      display: flex;
      align-items: center;
    }

    .profile-dropdown {
      position: relative;
      cursor: pointer;
    }

    .profile-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #e9ecef;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      border: 2px solid #f8f9fa;
      overflow: hidden;
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .dropdown-menu {
      width: 280px;
      padding: 0;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      border: none;
      overflow: hidden;
      margin-top: 10px;
    }

    .dropdown-header {
      padding: 1.2rem;
      border-bottom: 1px solid #eee;
      background: #f8f9fa;
    }

    .dropdown-user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .dropdown-item {
      padding: 0.8rem 1.2rem;
      transition: background-color 0.2s;
    }

    .dropdown-item:hover {
      background-color: #f0f4f8;
    }

    .dropdown-divider {
      margin: 0;
    }

    .profile-container {
      max-width: 800px;
      margin: 20px auto;
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .profile-header {
      text-align: center;
      padding-bottom: 20px;
      border-bottom: 2px solid #eee;
      margin-bottom: 20px;
      position: relative;
    }

    .large-avatar {
      width: 150px;
      height: 150px;
      border-radius: 75px;
      margin: 0 auto 15px;
      background-color: #f8f9fa;
      border: 3px solid #e9d5ff;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      position: relative;
    }

    .large-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .edit-avatar {
      position: absolute;
      bottom: 0;
      right: 0;
      background-color: #4a2d8b;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      transition: all 0.2s;
    }

    .edit-avatar:hover {
      transform: scale(1.1);
    }

    .form-label {
      font-weight: 600;
      color: #4a2d8b;
    }

    .btn-primary {
      background-color: #4a2d8b;
      border-color: #4a2d8b;
      padding: 8px 20px;
      font-weight: 600;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .btn-primary:hover {
      background-color: #3c2372;
      border-color: #3c2372;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .btn-secondary {
      background-color: #6c757d;
      border-color: #6c757d;
      padding: 8px 20px;
      font-weight: 600;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .btn-secondary:hover {
      background-color: #5a6268;
      border-color: #5a6268;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .avatar-selection-modal .modal-content {
      border-radius: 15px;
      overflow: hidden;
    }

    .avatar-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      padding: 15px;
    }

    .avatar-option {
      border-radius: 10px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
      border: 3px solid transparent;
      aspect-ratio: 1/1;
    }

    .avatar-option:hover {
      transform: scale(1.05);
    }

    .avatar-option.selected {
      border-color: #4a2d8b;
      box-shadow: 0 0 10px rgba(74, 45, 139, 0.5);
    }

    .avatar-option img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .user-form .form-control {
      border-radius: 8px;
      padding: 10px 15px;
      border: 1px solid #ced4da;
      transition: all 0.2s;
    }

    .user-form .form-control:focus {
      border-color: #4a2d8b;
      box-shadow: 0 0 0 0.25rem rgba(74, 45, 139, 0.25);
    }

    .modal-header,
    .modal-footer {
      border: none;
    }

    .modal-title {
      color: #4a2d8b;
      font-weight: 600;
    }

    .alert-success {
      background-color: #d1fae5;
      border-color: #a7f3d0;
      color: #047857;
      border-radius: 8px;
    }

    /* Estilos para la búsqueda y categorías */
    .avatar-search-container {
      margin-bottom: 15px;
    }

    .avatar-search-bar {
      position: relative;
      margin-bottom: 10px;
    }

    .avatar-search-bar input {
      padding-left: 40px;
      border-radius: 20px;
      border: 1px solid #ced4da;
      padding: 8px 15px 8px 40px;
      width: 100%;
    }

    .avatar-search-bar i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #6c757d;
    }

    .avatar-categories {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 15px;
    }

    .avatar-category {
      background-color: #f0f0f0;
      border-radius: 20px;
      padding: 5px 15px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .avatar-category:hover {
      background-color: #e0e0e0;
    }

    .avatar-category.active {
      background-color: #4a2d8b;
      color: white;
    }

    /* Grid de avatares con nombres */
    .avatar-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
    }

    .avatar-option {
      display: flex;
      flex-direction: column;
      border-radius: 10px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
      border: 3px solid transparent;
    }

    .avatar-option .avatar-img-container {
      aspect-ratio: 1/1;
      overflow: hidden;
    }

    .avatar-option img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .avatar-option .avatar-name {
      text-align: center;
      padding: 5px;
      font-size: 0.8rem;
      background-color: #f8f9fa;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Botón flotante de guardar */
    .modal-floating-footer {
      position: sticky;
      bottom: 0;
      background-color: white;
      padding: 10px;
      border-top: 1px solid #dee2e6;
      text-align: right;
      z-index: 10;
    }

    @media (max-width: 768px) {
      .navbar {
        padding: 0.8rem 1rem;
      }

      .navbar-items {
        width: 100%;
        justify-content: space-between;
      }

      .balance-display {
        margin-right: 0;
      }

      .avatar-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>

<body>
  <div class="main-container">
    <!-- Navbar Mejorado con Saldo -->
    <nav class="navbar navbar-expand-lg">
      <div class="container-fluid">
        <a class="navbar-brand" href="dashboard.html">
          <img
            src="https://img.evbuc.com/https%3A%2F%2Fcdn.evbuc.com%2Fimages%2F883171863%2F207532730700%2F1%2Foriginal.20241025-055049?w=512&auto=format%2Ccompress&q=75&sharp=10&rect=74%2C4%2C632%2C632&s=5e6a99698de97f7a0c5f18256bcfd582"
            alt="Logo Tantuyo" class="brand-logo">
          <div class="brand-text">
            <span class="brand-name">Tantuyo</span>
            <span class="brand-tagline">Centro Cultural</span>
          </div>
        </a>
        <div class="navbar-items ms-auto">
          <!-- Indicador de Saldo con Menú Desplegable -->
          <div class="balance-dropdown">
            <div class="balance-display" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fas fa-coins"></i>
              <span class="balance-value" id="userBalance">0.00 ₮</span>
            </div>
            <ul class="dropdown-menu balance-menu">
              <li>
                <a class="balance-item" href="Transferencias.html">
                  <i class="fas fa-exchange-alt"></i>
                  <span>Transferir</span>
                </a>
              </li>
              <li>
                <a class="balance-item" href="Historial.html">
                  <i class="fas fa-history"></i>
                  <span>Historial</span>
                </a>
              </li>
            </ul>
          </div>

          <div class="profile-dropdown" id="profileDropdown">
            <div class="profile-avatar" data-bs-toggle="dropdown" id="navProfileAvatar">
              <i class="fas fa-user text-secondary"></i>
            </div>
            <div class="dropdown-menu dropdown-menu-end">
              <div class="dropdown-header">
                <div class="dropdown-user-info">
                  <div class="profile-avatar" id="dropdownProfileAvatar">
                    <i class="fas fa-user text-secondary"></i>
                  </div>
                  <div>
                    <h6 class="mb-0" id="nombreCompletoDropdown"></h6>
                    <small class="text-muted" id="emailDropdown"></small>
                  </div>
                </div>
              </div>
              <a class="dropdown-item" href="TuPerfil.html"><i class="fas fa-user me-2"></i>Tu perfil</a>
              <a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>Configuración</a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item text-danger" href="#" onclick="cerrarSesion()">
                <i class="fas fa-sign-out-alt me-2"></i>Cerrar sesión
              </a>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Contenedor de Perfil -->
    <div class="profile-container">
      <div id="alertContainer"></div>

      <div class="profile-header">
        <div class="large-avatar" id="userAvatar">
          <i class="fas fa-user fa-3x text-secondary"></i>
        </div>
        <div class="edit-avatar" title="Editar foto de perfil" data-bs-toggle="modal" data-bs-target="#avatarModal">
          <i class="fas fa-camera"></i>
        </div>
        <h2 class="mt-3" id="nombreCompleto"></h2>
      </div>

      <form class="user-form" id="profileForm">
        <div class="row mb-4">
          <div class="col-md-6 mb-3">
            <label for="nombres" class="form-label">Nombres</label>
            <input type="text" class="form-control" id="nombres" name="nombres">
          </div>
          <div class="col-md-6 mb-3">
            <label for="apellidos" class="form-label">Apellidos</label>
            <input type="text" class="form-control" id="apellidos" name="apellidos">
          </div>
        </div>

        <div class="row mb-4">
          <div class="col-md-6 mb-3">
            <label for="edad" class="form-label">Edad</label>
            <input type="number" class="form-control" id="edad" name="edad">
          </div>
          <div class="col-md-6 mb-3">
            <label for="email" class="form-label">Email</label>
            <input type="email" class="form-control" id="email" name="email" disabled>
          </div>
        </div>

        <div class="row mb-4">
          <div class="col-md-6 mb-3">
            <label for="whatsapp" class="form-label">WhatsApp</label>
            <input type="text" class="form-control" id="whatsapp" name="whatsapp">
          </div>
          <div class="col-md-6 mb-3">
            <label for="instagram" class="form-label">Instagram</label>
            <input type="text" class="form-control" id="instagram" name="instagram">
          </div>
        </div>

        <div class="row mb-4">
          <div class="col-md-12 mb-3">
            <label for="animalEspiritual" class="form-label">Animal Espiritual</label>
            <input type="text" class="form-control" id="animalEspiritual" name="animalEspiritual" readonly>
            <small class="text-muted">Este campo se actualiza al elegir un avatar</small>
          </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-4">
          <a href="dashboard.html" class="btn btn-secondary">Cancelar</a>
          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal de Selección de Avatar -->
  <div class="modal fade avatar-selection-modal" id="avatarModal" tabindex="-1" aria-labelledby="avatarModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="avatarModalLabel">Elige tu foto de perfil</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="avatar-search-container">
            <div class="avatar-search-bar">
              <i class="fas fa-search"></i>
              <input type="text" id="avatarSearchInput" class="form-control" placeholder="Buscar por nombre...">
            </div>
            <div class="avatar-categories" id="avatarCategories">
              <!-- Las categorías se cargarán dinámicamente -->
            </div>
          </div>
          <div class="avatar-grid" id="avatarGrid">
            <!-- Las imágenes se cargarán dinámicamente con JavaScript -->
          </div>
          <div class="modal-floating-footer">
            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" id="saveAvatarBtn">Guardar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/config.js"></script>
  <script>
    const API_URL = config.API_URL;
    let selectedAvatar = null;
    let userData = null;

    async function verificarSesion() {
      const userId = localStorage.getItem("userId");
      if (!userId) {
        window.location.href = "login.html";
        return;
      }

      try {
        const response = await fetch(`${API_URL}/users/${userId}`);
        if (!response.ok) {
          throw new Error("Usuario no encontrado");
        }

        userData = await response.json();
        mostrarDatosUsuario(userData);
        await cargarAvatares();
      } catch (error) {
        console.error("Error:", error);
        localStorage.removeItem("userId");
        window.location.href = "login.html";
      }
    }

    function mostrarDatosUsuario(usuario) {
      // Dropdown info
      document.getElementById("nombreCompletoDropdown").textContent =
        `${usuario.nombres} ${usuario.apellidos}`;
      document.getElementById("emailDropdown").textContent = usuario.email;

      // Nombre completo en header
      document.getElementById("nombreCompleto").textContent =
        `${usuario.nombres} ${usuario.apellidos}`;

      // Datos en el formulario
      document.getElementById("nombres").value = usuario.nombres || '';
      document.getElementById("apellidos").value = usuario.apellidos || '';
      document.getElementById("edad").value = usuario.edad || '';
      document.getElementById("email").value = usuario.email || '';
      document.getElementById("whatsapp").value = usuario.whatsapp || '';
      document.getElementById("instagram").value = usuario.instagram || '';
      document.getElementById("animalEspiritual").value = usuario.animalEspiritual || '';

      // Mostrar saldo con formato
      const saldo = parseFloat(usuario.saldo || 0).toFixed(2);
      const balanceElement = document.getElementById("userBalance");
      balanceElement.textContent = `${saldo} ₮`;

      // Destacar saldo negativo
      if (parseFloat(saldo) < 0) {
        balanceElement.classList.add('text-danger');
      } else {
        balanceElement.classList.remove('text-danger');
      }

      // Si tiene animal espiritual, mostrar el avatar correspondiente
      if (usuario.animalEspiritual) {
        mostrarAvatarPorNombre(usuario.animalEspiritual);
      }
    }

    // Configuración para clasificar avatares
    // Configuración para clasificar avatares
    const animalCategories = {
      'Mamíferos': [
        'Aardvark', 'Alce', 'Alpaca', 'Antílope', 'Ardilla', 'Armadillo', 'Aye-Aye', 'Babuino',
        'Ballena', 'Beluga', 'Borrego', 'Búfalo', 'Caballo', 'Cabra', 'Cacomixtle', 'Camello',
        'Canguro', 'Capibara', 'Caracal', 'Castor', 'Cebra', 'Cerdo', 'Chimpancé', 'Chita',
        'Ciervo', 'Civeta', 'Coati', 'Conejo', 'Coyote', 'Cuy', 'Delfín', 'Dhole', 'Elefante',
        'Erizo', 'Foca', 'Gacela', 'Gato', 'Gibón', 'Gorilla', 'Guanaco', 'Guepardo', 'Hámster',
        'Hiena', 'Hipopótamo', 'Hurón', 'Impala', 'Jabalí', 'Jaguar', 'Jirafa', 'Koala', 'Leopardo',
        'León', 'Liebre', 'Lince', 'Llama', 'Lobo', 'Lémur', 'Manatí', 'Mangosta', 'Mapache',
        'Margay', 'Marmota', 'Mico', 'Mini Cerdo', 'Mono', 'Morsa', 'Muntjac', 'Murciélago',
        'Musaraña', 'Narval', 'Nutria', 'Ocelote', 'Okapi', 'Orangután', 'Orca', 'Oricteropo',
        'Oso', 'Oveja', 'Panda', 'Pangolín', 'Pantera', 'Perro', 'Pony', 'Puercoespín', 'Puma',
        'Quokka', 'Rata', 'Ratel', 'Ratón', 'Rinoceronte', 'Serval', 'Sifaka', 'Solenodon',
        'Suricata', 'Tapir', 'Tarsero', 'Tejón', 'Teporingo', 'Tigre', 'Tigrillo', 'Tití',
        'Tlacuache', 'Topo', 'Vaca', 'Vaquita Marina', 'Wallaby', 'Wombat', 'Xoloitzcuintle',
        'Zarigüeya', 'Zorrillo', 'Zorro', 'Íbice', 'Ñu', 'Órix'
      ],
      'Aves': [
        'Aguililla', 'Avestruz', 'Buitre', 'Búho', 'Cacatúa', 'Canario', 'Caracaraç', 'Casuario',
        'Cenzontle', 'Cigüeña', 'Cisne', 'Codorniz', 'Colibrí', 'Colobo', 'Cotorra', 'Cuervo',
        'Cóndor', 'Faisán', 'Flamenco', 'Frailecillo', 'Gallina', 'Gallo', 'Garza', 'Gavilán',
        'Gaviota', 'Gorrión', 'Grulla', 'Guacamaya', 'Halcón', 'Ibis', 'Jabirú', 'Kakapo',
        'Lechuza', 'Loro', 'Marabú', 'Moa', 'Oropéndola', 'Paloma', 'Pato', 'Pavo', 'Pelícano',
        'Perdiz', 'Perico', 'Periquito', 'Pingüino', 'Quetzal', 'Saltarín', 'Seriema', 'Sinsonte',
        'Tecolote', 'Trepador', 'Tucán', 'Turaco', 'Tórtola', 'Uakari', 'Urraca', 'Zopilote',
        'Águila', 'Ñandú', 'Pájaro'
      ],
      'Reptiles': [
        'Ajolote', 'Ameiva', 'Anaconda', 'Basilisco', 'Boa', 'Caguama', 'Caimán', 'Camaleón',
        'Cocodrilo', 'Cobra', 'Coralillo', 'Culebra', 'Drágon', 'Galápago', 'Gecko', 'Iguana',
        'Lagarto', 'Pogona', 'Serpiente', 'Tortuga', 'Varano'
      ],
      'Anfibios': [
        'Rana', 'Salamandra', 'Sapo'
      ],
      'Peces': [
        'Hipocampo', 'Mantarraya', 'Pez', 'Piraña', 'Sargo', 'Tiburón'
      ],
      'Invertebrados': [
        'Alacrán', 'Avispa', 'Calamar', 'Camarón', 'Cangrego', 'Cangrejo', 'Caracol', 'Chinche',
        'Escarabajo', 'Escorpión', 'Estrella de mar', 'Grillo', 'Hormiga', 'Libélula', 'Luciérnaga',
        'Mantis', 'Mariposa', 'Medusa', 'Mosca', 'Mosquito', 'Nudibranquio', 'Oruga', 'Pulpo',
        'Saltamontes', 'Tarántula', 'Tábano'
      ],
      'Míticos': [
        'Fénix'
      ]
    };

    async function cargarAvatares() {
      try {
        // Obtener avatares del servidor
        const response = await fetch(`${API_URL}/avatars`);

        if (!response.ok) {
          throw new Error('Error al obtener avatares');
        }

        const avatarImages = await response.json();

        // Guardar en variable global para uso posterior
        window.avatarImages = avatarImages;

        // Procesar los datos de los avatares para añadir categorías
        window.avatarImages = procesarDatosAvatares(avatarImages);

        // Cargar las categorías en el UI
        cargarCategorias();

        // Configurar búsqueda
        configurarBusqueda();

        const avatarGrid = document.getElementById('avatarGrid');
        avatarGrid.innerHTML = '';

        avatarImages.forEach(avatar => {
          const avatarOption = document.createElement('div');
          avatarOption.className = 'avatar-option';
          avatarOption.dataset.avatarId = avatar.id;

          // Extraer nombre del animal
          const fileName = avatar.fileName.split('.')[0];
          const animalName = fileName.replace(/[-_]/g, ' ');

          // Si este avatar es el seleccionado actualmente, marcarlo
          if (userData && userData.animalEspiritual) {
            // Normalizar ambos nombres para comparación
            const normalizedUserAnimal = userData.animalEspiritual.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '');
            const normalizedAnimalName = animalName.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '');

            if (normalizedUserAnimal === normalizedAnimalName) {
              avatarOption.classList.add('selected');
              selectedAvatar = avatar.id;
            }
          }

          // Contenedor para la imagen
          const imgContainer = document.createElement('div');
          imgContainer.className = 'avatar-img-container';

          const img = document.createElement('img');
          img.src = avatar.url;
          img.alt = animalName;

          imgContainer.appendChild(img);

          // Elemento para el nombre
          const nameElement = document.createElement('div');
          nameElement.className = 'avatar-name';
          nameElement.textContent = animalName;

          avatarOption.appendChild(imgContainer);
          avatarOption.appendChild(nameElement);
          avatarGrid.appendChild(avatarOption);

          // Añadir el evento click
          avatarOption.addEventListener('click', function () {
            // Quitar la clase 'selected' de todos
            document.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('selected'));

            // Añadir la clase 'selected' al elemento clickeado
            this.classList.add('selected');

            // Guardar el id del avatar seleccionado
            selectedAvatar = this.dataset.avatarId;
          });
        });

        // Mostrar el avatar actual del usuario
        if (userData && userData.animalEspiritual) {
          mostrarAvatarPorNombre(userData.animalEspiritual);
        }

      } catch (error) {
        console.error('Error al cargar avatares:', error);
        mostrarAlerta('No se pudieron cargar los avatares', 'danger');
      }
    }

    function procesarDatosAvatares(avatares) {
      return avatares.map(avatar => {
        // Extraer nombre del archivo de la URL
        const urlParts = avatar.url.split('/');
        const fileName = urlParts[urlParts.length - 1]; // Obtener última parte de la URL

        // Quitar extensión y formatear nombre
        let name = fileName.split('.')[0];

        // Determinar la categoría
        let category = 'Otros';

        // Comprobar en qué categoría encaja
        categoryLoop:
        for (const [cat, animals] of Object.entries(animalCategories)) {
          for (const animal of animals) {
            // Comprobar si el nombre contiene el animal (como palabra completa o al principio)
            if (name === animal ||
              name.startsWith(animal + ' ') ||
              name.includes(' ' + animal)) {
              category = cat;
              break categoryLoop;
            }
          }
        }

        // Casos especiales para nombres compuestos (por ejemplo, "Pez León")
        if (category === 'Otros') {
          if (name.startsWith('Pez ')) {
            category = 'Peces';
          } else if (name.startsWith('Pájaro ')) {
            category = 'Aves';
          }
        }

        return {
          ...avatar,
          name: name,
          category: category
        };
      });
    }

    function cargarCategorias() {
      const categoriesContainer = document.getElementById('avatarCategories');
      categoriesContainer.innerHTML = '';

      // Añadir categoría "Todos"
      const allCategory = document.createElement('div');
      allCategory.className = 'avatar-category active';
      allCategory.dataset.category = 'all';
      allCategory.textContent = 'Todos';
      categoriesContainer.appendChild(allCategory);

      // Obtener categorías únicas de los avatares
      const uniqueCategories = [...new Set(window.avatarImages.map(avatar => avatar.category))];

      // Crear elementos para cada categoría
      uniqueCategories.forEach(category => {
        const categoryElement = document.createElement('div');
        categoryElement.className = 'avatar-category';
        categoryElement.dataset.category = category;
        categoryElement.textContent = category;
        categoriesContainer.appendChild(categoryElement);
      });

      // Añadir eventos click a las categorías
      document.querySelectorAll('.avatar-category').forEach(category => {
        category.addEventListener('click', function () {
          // Quitar clase active de todas las categorías
          document.querySelectorAll('.avatar-category').forEach(cat => {
            cat.classList.remove('active');
          });

          // Añadir clase active a la categoría clickeada
          this.classList.add('active');

          // Filtrar avatares por categoría
          const selectedCategory = this.dataset.category;
          let filteredAvatars;

          if (selectedCategory === 'all') {
            filteredAvatars = window.avatarImages;
          } else {
            filteredAvatars = window.avatarImages.filter(avatar =>
              avatar.category === selectedCategory
            );
          }

          // Aplicar también el filtro de búsqueda actual
          const searchTerm = document.getElementById('avatarSearchInput').value.toLowerCase();
          if (searchTerm) {
            filteredAvatars = filteredAvatars.filter(avatar =>
              avatar.name.toLowerCase().includes(searchTerm)
            );
          }

          renderizarAvatares(filteredAvatars);
        });
      });
    }

    function renderizarAvatares(avatares) {
      const avatarGrid = document.getElementById('avatarGrid');
      avatarGrid.innerHTML = '';

      if (avatares.length === 0) {
        const noResults = document.createElement('div');
        noResults.className = 'text-center p-4 w-100';
        noResults.innerHTML = '<i class="fas fa-search fa-2x mb-2 text-muted"></i><p>No se encontraron resultados</p>';
        avatarGrid.appendChild(noResults);
        return;
      }

      // Ordenar avatares por nombre
      avatares.sort((a, b) => a.name.localeCompare(b.name, 'es'));

      avatares.forEach(avatar => {
        const avatarOption = document.createElement('div');
        avatarOption.className = 'avatar-option';
        avatarOption.dataset.avatarId = avatar.id;

        // Extraer nombre del animal
        let animalName = avatar.name;
        if (!animalName && avatar.url) {
          const fileName = avatar.url.split('/').pop().split('.')[0];
          animalName = fileName.replace(/[-_]/g, ' ');
        }

        // Si este avatar es el seleccionado actualmente, marcarlo
        if (userData && userData.animalEspiritual) {
          // Normalizar ambos nombres para comparación
          const normalizedUserAnimal = userData.animalEspiritual.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '');
          const normalizedAnimalName = animalName.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '');

          if (normalizedUserAnimal === normalizedAnimalName) {
            avatarOption.classList.add('selected');
            selectedAvatar = avatar.id;
          }
        }

        // Contenedor para la imagen
        const imgContainer = document.createElement('div');
        imgContainer.className = 'avatar-img-container';

        const img = document.createElement('img');
        img.src = avatar.url;
        img.alt = animalName;

        imgContainer.appendChild(img);

        // Elemento para el nombre
        const nameElement = document.createElement('div');
        nameElement.className = 'avatar-name';
        nameElement.textContent = animalName;

        avatarOption.appendChild(imgContainer);
        avatarOption.appendChild(nameElement);
        avatarGrid.appendChild(avatarOption);

        // Añadir el evento click
        avatarOption.addEventListener('click', function () {
          // Quitar la clase 'selected' de todos
          document.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('selected'));

          // Añadir la clase 'selected' al elemento clickeado
          this.classList.add('selected');

          // Guardar el id del avatar seleccionado
          selectedAvatar = this.dataset.avatarId;
        });
      });
    }

    function configurarBusqueda() {
      const searchInput = document.getElementById('avatarSearchInput');

      searchInput.addEventListener('input', function () {
        const searchTerm = this.value.toLowerCase();

        // Obtener la categoría actualmente seleccionada
        const activeCategory = document.querySelector('.avatar-category.active').dataset.category;

        // Filtrar primero por categoría
        let filteredAvatars;
        if (activeCategory === 'all') {
          filteredAvatars = window.avatarImages;
        } else {
          filteredAvatars = window.avatarImages.filter(avatar =>
            avatar.category === activeCategory
          );
        }

        // Luego aplicar el filtro de búsqueda
        if (searchTerm) {
          filteredAvatars = filteredAvatars.filter(avatar =>
            avatar.name.toLowerCase().includes(searchTerm)
          );
        }

        renderizarAvatares(filteredAvatars);
      });
    }

    function mostrarAvatar(avatarId) {
      // Esta función ya no debería usarse, pero la mantenemos para compatibilidad
      // Buscar el avatar seleccionado
      const avatar = window.avatarImages.find(img => img.id === avatarId);

      if (avatar) {
        // Extraer nombre del animal del archivo
        const fileName = avatar.fileName.split('.')[0];
        const animalName = fileName.replace(/[-_]/g, ' ');

        // Usar la función que muestra por nombre
        mostrarAvatarPorNombre(animalName);
      }
    }

    function mostrarAvatarPorNombre(nombreAnimal) {
      if (!window.avatarImages || !nombreAnimal) return;

      // Normalizar el nombre del animal para la comparación
      const nombreFormateado = nombreAnimal.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '');

      // Buscar el avatar por nombre
      const avatar = window.avatarImages.find(img => {
        // Extraer nombre del archivo
        const fileName = img.fileName.split('.')[0];
        // Normalizar nombre del archivo de la misma manera
        const fileNameNormalized = fileName.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[-_]/g, '').replace(/\s+/g, '');

        return fileNameNormalized === nombreFormateado;
      });

      if (avatar) {
        // Reemplazar los iconos de usuario por la imagen en todos los lugares necesarios
        const avatarContainers = [
          document.getElementById('userAvatar'),
          document.getElementById('navProfileAvatar'),
          document.getElementById('dropdownProfileAvatar')
        ];

        avatarContainers.forEach(container => {
          if (container) {
            // Limpiar el contenedor
            container.innerHTML = '';

            // Crear y añadir la imagen
            const img = document.createElement('img');
            img.src = avatar.url;
            img.alt = 'Avatar de usuario';
            container.appendChild(img);
          }
        });
      }
    }

    // Evento para guardar el avatar seleccionado
    document.getElementById('saveAvatarBtn').addEventListener('click', async function () {
      if (selectedAvatar) {
        try {
          const userId = localStorage.getItem("userId");
          const avatar = window.avatarImages.find(img => img.id === selectedAvatar);

          if (!avatar) {
            throw new Error('Avatar no encontrado');
          }

          // Extraer nombre del animal del archivo
          const fileName = avatar.fileName.split('.')[0];
          const animalEspiritual = fileName.replace(/[-_]/g, ' ');

          // Actualizar el animal espiritual en el backend
          const response = await fetch(`${API_URL}/users/${userId}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              animalEspiritual: animalEspiritual
            })
          });

          if (!response.ok) {
            throw new Error('Error al actualizar el animal espiritual');
          }

          // Actualizar datos locales
          userData.animalEspiritual = animalEspiritual;

          // Actualizar la UI con el nuevo avatar
          mostrarAvatarPorNombre(animalEspiritual);

          // Actualizar el campo en el formulario
          document.getElementById("animalEspiritual").value = animalEspiritual;

          // Cerrar el modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('avatarModal'));
          modal.hide();

          // Mostrar mensaje de éxito
          mostrarAlerta('Animal espiritual actualizado correctamente', 'success');

        } catch (error) {
          console.error('Error:', error);
          mostrarAlerta('Error al actualizar el animal espiritual', 'danger');
        }
      }
    });

    // Manejar el envío del formulario de perfil
    document.getElementById('profileForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      try {
        const userId = localStorage.getItem("userId");

        // Recoger los datos del formulario
        const formData = {
          nombres: document.getElementById('nombres').value,
          apellidos: document.getElementById('apellidos').value,
          edad: document.getElementById('edad').value,
          whatsapp: document.getElementById('whatsapp').value,
          instagram: document.getElementById('instagram').value
        };

        // Actualizar los datos en el backend
        const response = await fetch(`${API_URL}/users/${userId}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        });

        if (!response.ok) {
          throw new Error('Error al actualizar el perfil');
        }

        // Mostrar mensaje de éxito
        mostrarAlerta('Perfil actualizado correctamente', 'success');

        // Actualizar datos locales
        userData = { ...userData, ...formData };

      } catch (error) {
        console.error('Error:', error);
        mostrarAlerta('Error al actualizar el perfil', 'danger');
      }
    });

    function mostrarAlerta(mensaje, tipo) {
      const alertContainer = document.getElementById('alertContainer');

      // Crear la alerta
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${tipo} alert-dismissible fade show`;
      alertDiv.role = 'alert';

      alertDiv.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;

      // Añadir al contenedor
      alertContainer.innerHTML = '';
      alertContainer.appendChild(alertDiv);

      // Eliminar automáticamente después de 5 segundos
      setTimeout(() => {
        const alert = bootstrap.Alert.getOrCreateInstance(alertDiv);
        alert.close();
      }, 5000);
    }

    function cerrarSesion() {
      localStorage.removeItem("userId");
      window.location.href = "index.html";
    }

    verificarSesion();
  </script>
</body>

</html>